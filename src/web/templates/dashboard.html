{% extends "base.html" %}
{% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
{% block content %}
<div class="grid">
  <div class="card">
    <h2 style="margin-top:0;">Run a simulation</h2>
    <form method="post" action="/api/simulations" style="display:flex; flex-direction:column; gap:12px;">
      <label>Layout
        <select name="layout" required style="width:100%; padding:10px; border-radius:8px; border:1px solid #cbd5e1;">
          {% for layout in layouts %}
          <option value="{{ layout.id }}">{{ layout.id }}</option>
          {% endfor %}
        </select>
      </label>
      <label>Steps
        <input type="number" name="steps" value="120" min="10" max="1000" style="width:100%; padding:10px; border-radius:8px; border:1px solid #cbd5e1;" />
      </label>
      <label>Arrival intensity
        <input type="number" step="0.1" name="arrival_intensity" value="0.7" style="width:100%; padding:10px; border-radius:8px; border:1px solid #cbd5e1;" />
      </label>
      <label>Crossing rate
        <input type="number" step="0.1" name="crossing_rate" value="0.2" style="width:100%; padding:10px; border-radius:8px; border:1px solid #cbd5e1;" />
      </label>
      <button class="btn" type="submit">Launch simulation</button>
    </form>
  </div>
  <div class="card">
    <h2 style="margin-top:0;">Analytics snapshot</h2>
    <div class="grid">
      <div>
        <div class="metric">{{ '%.2f' | format(analytics.avg_queue) }}</div>
        <div style="color:#475569">Avg queue (vehicles)</div>
      </div>
      <div>
        <div class="metric">{{ '%.2f' | format(analytics.max_queue) }}</div>
        <div style="color:#475569">Peak queue</div>
      </div>
      <div>
        <div class="metric">{{ '%.2f' | format(analytics.avg_pedestrians) }}</div>
        <div style="color:#475569">Avg pedestrians</div>
      </div>
      <div>
        <div class="metric">{{ analytics.runs }}</div>
        <div style="color:#475569">Completed runs</div>
      </div>
    </div>
    <canvas id="queueChart" style="margin-top:16px; height:200px;"></canvas>
  </div>
</div>
<div class="card">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
    <h2 style="margin:0;">Recent runs</h2>
    <small style="color:#475569;">Download Omniverse traces to drive digital twins.</small>
  </div>
  <table>
    <thead>
      <tr>
        <th>Run</th>
        <th>Layout</th>
        <th>Steps</th>
        <th>Arrival</th>
        <th>Crossing</th>
        <th>Avg queue</th>
        <th>Max queue</th>
        <th>Omniverse</th>
      </tr>
    </thead>
    <tbody>
      {% for run in runs %}
      <tr>
        <td>{{ run.id[:8] }}</td>
        <td>{{ run.layout }}</td>
        <td>{{ run.steps }}</td>
        <td>{{ '%.2f' | format(run.arrival_intensity) }}</td>
        <td>{{ '%.2f' | format(run.crossing_rate) }}</td>
        <td>{{ '%.2f' | format(run.metrics.avg_queue if run.metrics.avg_queue is defined else run.metrics['avg_queue']) }}</td>
        <td>{{ '%.2f' | format(run.metrics.max_queue if run.metrics.max_queue is defined else run.metrics['max_queue']) }}</td>
        <td><a href="/api/simulations/{{ run.id }}/omniverse">Download</a></td>
      </tr>
      {% endfor %}
      {% if runs|length == 0 %}
      <tr><td colspan="8" style="text-align:center; color:#475569; padding:14px;">No runs yet. Launch your first simulation above.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>
{% endblock %}
{% block footer_scripts %}
<script>
  const ctx = document.getElementById('queueChart');
  const history = {{ runs|map(attribute='metrics')|list|tojson }};
  const labels = history.map((_, idx) => `Run ${idx + 1}`);
  const avgQueues = history.map(h => h ? h.avg_queue || h['avg_queue'] : 0);
  const maxQueues = history.map(h => h ? h.max_queue || h['max_queue'] : 0);
  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Average queue', data: avgQueues, borderColor: '#0ea5e9', tension: 0.3 },
        { label: 'Peak queue', data: maxQueues, borderColor: '#1d4ed8', tension: 0.3 }
      ]
    },
    options: {
      plugins: { legend: { display: true } },
      scales: { y: { beginAtZero: true } }
    }
  });
</script>
{% endblock %}
